<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Clusters Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    .swatch{
  display:inline-block; width:12px; height:12px; border-radius:3px;
  margin-right:6px; vertical-align:-2px;
  border:1px solid rgba(255,255,255,.2);
}
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0b0f17; color:#eee; }
    #wrap { display: grid; grid-template-columns: 320px 1fr; height: 100%; }
    #sidebar { padding: 12px 14px; border-right: 1px solid #222; overflow: auto; }
    #chart { width: 100%; height: 100%; }
    .cluster { margin: 6px 0; padding: 8px; border-radius: 8px; background: #121826; cursor: pointer; }
    .cluster.active { outline: 2px solid #6ea8fe; }
    .muted { color: #9aa4b2; }
    input[type="search"]{ width: 100%; padding: 8px 10px; border-radius: 8px; border: 1px solid #333; background: #0f1522; color: #eee; }
    .pill { display:inline-block; background:#1c2537; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:6px;}
  </style>
</head>
<body>
<div id="wrap">
  <div id="sidebar">
    <h1 style="margin: 0 0 10px;">Web Galaxy</h1>
    <div class="muted" style="margin:4px 0 12px; font-size:12px; line-height:1.3;">
  dataset used: <code>Plugiloinc/45_Million_Websites</code> (10k ex)<br>
  embedding model: <code>nvidia/NV-Embed-v2</code> 7b<br>
  clustering: <code>umap.UMAP(n_components=3, n_neighbors=15, min_dist=0.1)</code>
</div>

    <h2 style="margin: 6px 0 10px;">Clusters</h2>
    <div id="legend"></div>
    <p class="muted">Click a cluster to filter; click again to reset.</p>
  </div>
  <div id="chart"></div>
</div>

<!-- ECharts + 3D -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts-gl@2/dist/echarts-gl.min.js"></script>

<script>
(async function(){
  const res = await fetch('clusters.json');
  const data = await res.json();
  const clusters = data.clusters;
  const points = data.points;

  const PALETTE = ['#4aa8ff','#8ccef4','#33c6a0','#f5ed72','#e6843f','#e1a8cc','#7a6ad6','#78c8be','#4aa17e','#e19aa7','#bfbfbf','#995533'];
const colorForCluster = (id) => PALETTE[Math.abs(id) % PALETTE.length];

clusters.forEach(c => { c.color = colorForCluster(c.id); });


  // Build legend
  const legendDiv = document.getElementById('legend');
  legendDiv.innerHTML = '';
  clusters.forEach(c => {
    const el = document.createElement('div');
    el.className = 'cluster';
    el.dataset.clusterId = c.id;
    //el.textContent = `#${c.id} — ${c.keywords}`;
    el.innerHTML = `<span class="swatch" style="background:${c.color}"></span>#${c.id} — ${c.keywords}`;

    const pill = document.createElement('span');
    pill.className = 'pill';
    pill.textContent = c.size;
    el.appendChild(pill);
    legendDiv.appendChild(el);
  });

  // Build series: one scatter per cluster for fast filtering
  const clusterMap = new Map(clusters.map(c => [c.id, []]));
  points.forEach(p => {
    clusterMap.get(p.cluster).push({
      value: p.pos, // [x,y,z]
      name: p.title || p.id,
      itemStyle: {},
      meta: p
    });
  });

  


  const chart = echarts.init(document.getElementById('chart'));
const series = clusters.flatMap(c => {
  const data = clusterMap.get(c.id);
  return [
    // core
    {
      type: 'scatter3D',
      name: `Cluster ${c.id}`,
      data: clusterMap.get(c.id),
      symbolSize: 4,
      itemStyle: { color: c.color, opacity: 0.9 },
      emphasis: { focus: 'series', itemStyle: { opacity: 1 } }
    }
  ];
});

  const option = {
    backgroundColor: '#0b0f17',
tooltip: {
    confine: true,
    enterable: true,
    extraCssText: 'max-width:360px; white-space:normal; overflow-wrap:anywhere; line-height:1.2;',
    formatter: (p) => {
      const m = p.data.meta;
      const sum = (m.summary || '').replace(/\s+/g,' ').slice(0, 360) + ((m.summary||'').length>360 ? '…' : '');
      return `
        <div style="max-width:360px; white-space:normal; overflow-wrap:anywhere; line-height:1.2;">
          <b>${m.title || m.id}</b><br>
          <span class="muted">${m.id}</span><br>
          ${sum}
        </div>`;
    }
  },




    legend: { show: false },
    xAxis3D: { type: 'value',
    splitLine: { show: false },
    },
    yAxis3D: { type: 'value',
    splitLine: { show: false },
     },
    zAxis3D: { type: 'value',
        splitLine: { show: false },

     },
    grid3D: {
      viewControl: { projection: 'perspective', autoRotate: false },
      boxWidth: 180, boxDepth: 180, boxHeight: 180,
      environment: 'space.jpg', 
      postEffect: {
    enable: true,
    bloom: {
      enable: true,
      // optional tunables—safe defaults:
      threshold: 0.0,   // lower = more pixels glow
      blurSize: 4       // larger = softer halo
    },
    // turn off the heavier ones unless you need them
    SSAO: { enable: false },
    depthOfField: { enable: false }
  },
  temporalSuperSampling: { enable: true }
    },
    series
  };
  chart.setOption(option);

  function normalizeUrl(meta) {
  const raw = meta.picked_url || meta.id || '';
  if (!raw) return null;
  if (/^https?:\/\//i.test(raw)) return raw;
  return 'https://' + raw.replace(/^\/+/, '');
}

chart.on('click', (params) => {
  // Only react to point clicks
  if (!params?.data?.meta) return;
  const url = normalizeUrl(params.data.meta);
  if (url) window.open(url, '_blank', 'noopener');
});

  // Filtering by clicking legend items
  let activeCluster = null;
  const legend = document.getElementById('legend');
  legend.addEventListener('click', (ev) => {
    const el = ev.target.closest('.cluster');
    if (!el) return;
    const cid = +el.dataset.clusterId;
    const already = activeCluster === cid;
    document.querySelectorAll('.cluster').forEach(x => x.classList.remove('active'));
    if (already) {
      activeCluster = null;
      chart.setOption({ series: series });
    } else {
      activeCluster = cid;
      el.classList.add('active');
      chart.setOption({ series: [ series[cid] ] });
    }
  });

  // Simple search highlighting
  const search = document.getElementById('search');
  search.addEventListener('input', () => {
    const q = search.value.trim().toLowerCase();
const newSeries = series.map(s => ({
  ...s,
  data: s.data.map(d => {
    const hay = (d.meta.title || d.meta.id || '').toLowerCase();
    const hit = q && hay.includes(q);
    const op = hit ? 1 : (q ? 0.2 : 1);
    return { ...d, itemStyle: { ...(d.itemStyle || {}), opacity: op } };
  })
}));
    chart.setOption({ series: activeCluster==null ? newSeries : [ newSeries[activeCluster] ] });
  });

  window.addEventListener('resize', () => chart.resize());
})();
</script>
</body>
</html>
